view: spend_view2 {
  sql_table_name: `your_project.your_dataset.SPEND_VIEW_2` ;;

  # ======================== DIMENSION GROUPS (DATES) =========================
  dimension_group: mt_posting_date {
    type: time
    timeframes: [raw, date, week, month, quarter, year]
    label: "Posting Date"
    group_label: "Transaction Dates"
    description: "Date the transaction was posted"
    sql: ${TABLE}.MT_POSTING_DATE ;;
  }

  # ======================== DIMENSIONS (SCHEMA FIELDS) =======================

  dimension: acct {
    type: string
    label: "Account Number"
    group_label: "Account Information"
    description: "Customer account number used for the transaction"
    sql: ${TABLE}.acct ;;
  }

  dimension: mcc_code {
    type: string
    label: "MCC Code"
    group_label: "Merchant Info"
    description: "Merchant Category Code (MCC)"
    sql: CAST(${TABLE}.MCC_CODE AS STRING) ;;
  }

  dimension: description {
    type: string
    label: "MCC Description"
    group_label: "Merchant Info"
    description: "Description of the MCC"
    sql: ${TABLE}.Description ;;
  }

  dimension: merchant_details {
    type: string
    label: "Merchant Details"
    group_label: "Merchant Info"
    description: "Raw merchant information from the transaction"
    sql: ${TABLE}.Merchant_Details ;;
  }

  dimension: org {
    type: number
    label: "Organization ID"
    group_label: "Card/Product Info"
    description: "Organization identifier"
    sql: ${TABLE}.ORG ;;
  }

  dimension: transaction_type {
    type: string
    label: "Transaction Type"
    group_label: "Transaction Details"
    description: "POS, Ecommerce, Cash, etc."
    sql: ${TABLE}.TRANSACTION_TYPE ;;
  }

  dimension: spend_type {
    type: string
    label: "Spend Type"
    group_label: "Transaction Details"
    description: "Type of spend (e.g., Debit, EMI, etc.)"
    sql: ${TABLE}.SPEND_TYPE ;;
  }

  dimension: segment_name {
    type: string
    label: "Segment Name"
    group_label: "Merchant Info"
    description: "Segment/category of the merchant"
    sql: ${TABLE}.Segment_Name ;;
  }

  dimension: mt_type {
    type: string
    label: "MT Type"
    group_label: "Card/Product Info"
    description: "Card type used (if available)"
    sql: ${TABLE}.mt_type ;;
  }

  dimension: spend_place {
    type: string
    label: "Transaction Geography"
    group_label: "Transaction Details"
    description: "DOM = Domestic, FR = International"
    sql: ${TABLE}.Spend_Place ;;
  }

  dimension: product {
    type: string
    label: "Product"
    group_label: "Card/Product Info"
    description: "Product or card type used"
    sql: ${TABLE}.Product ;;
  }

  dimension: spend_amount {
    type: number
    label: "Spend Amount"
    group_label: "Transaction Amounts"
    description: "Amount spent in the transaction"
    sql: ${TABLE}.Spend_Amount ;;
  }

  dimension: reversal_amount {
    type: number
    label: "Reversal Amount"
    group_label: "Transaction Amounts"
    description: "Amount reversed for the transaction"
    sql: ${TABLE}.Reversal_Amount ;;
  }

  dimension: net_transaction {
    type: number
    label: "Net Transaction"
    group_label: "Transaction Amounts"
    description: "Net spend after reversal"
    sql: ${TABLE}.Net_Transaction ;;
  }

  dimension: spend_amount_cmb {
    type: number
    label: "Spend Amount CMB"
    group_label: "Transaction Amounts"
    description: "Spend amount CMB"
    sql: ${TABLE}.SPEND_AMOUNT_CMB ;;
  }

  dimension: spend_amount_rbmw {
    type: number
    label: "Spend Amount RBMW"
    group_label: "Transaction Amounts"
    description: "Spend amount RBMW"
    sql: ${TABLE}.SPEND_AMOUNT_RBMW ;;
  }

  dimension: mt_ref_nbr {
    type: string
    label: "Transaction Reference Number"
    group_label: "Transaction Info"
    description: "Unique transaction reference number"
    sql: ${TABLE}.MT_REF_NBR ;;
    primary_key: yes
  }

  dimension: brand {
    type: string
    label: "Brand"
    group_label: "Merchant Info"
    description: "Brand associated with the transaction"
    sql: ${TABLE}.BRAND ;;
  }

  dimension: final_category {
    type: string
    label: "Final Category"
    group_label: "Merchant Info"
    description: "Final category of the transaction"
    sql: ${TABLE}.FINAL_CATEGORY ;;
  }

  dimension: category_general_desc {
    type: string
    label: "Category General Description"
    group_label: "Merchant Info"
    description: "General description of the merchant category"
    sql: ${TABLE}.CATEGORY_GENERAL_DESC ;;
  }

  dimension: category_desc {
    type: string
    label: "Category Description"
    group_label: "Merchant Info"
    description: "Detailed description of the merchant category"
    sql: ${TABLE}.CATEGORY_DESC ;;
  }

  # ======================== DERIVED DIMENSIONS ===============================

  dimension: merchant_name {
    type: string
    label: "Merchant Name"
    group_label: "Merchant Info"
    description: "Parsed merchant name from merchant_details"
    sql: SUBSTRING(${TABLE}.Merchant_Details, 1, 24) ;;
  }

  dimension: merchant_city {
    type: string
    label: "Merchant City"
    group_label: "Merchant Info"
    description: "Parsed merchant city from merchant_details"
    sql: REPLACE(SUBSTRING(${TABLE}.Merchant_Details, 24, 14), " ", "") ;;
  }

  dimension: merchant_country {
    type: string
    label: "Merchant Country"
    group_label: "Merchant Info"
    description: "Parsed merchant country from merchant_details"
    sql: SUBSTRING(${TABLE}.Merchant_Details, 38, 2) ;;
  }

  dimension: mcc_combo {
    type: string
    label: "MCC Combo"
    group_label: "Merchant Info"
    description: "MCC code and description combo"
    sql: CONCAT(${mcc_code}, " - ", ${description}) ;;
  }

  # ======================== DATE UTILITIES ===================================

  dimension: today {
    type: date
    label: "Today's Date"
    group_label: "Date Utilities"
    description: "Current system date"
    sql: current_date() ;;
  }

  dimension: day {
    type: number
    label: "Current Day"
    group_label: "Date Utilities"
    description: "Today's day of the month"
    sql: CAST(FORMAT_DATE('%e', current_date()) AS INT64) ;;
  }

  dimension: mon {
    type: number
    label: "Current Month"
    group_label: "Date Utilities"
    description: "Current month"
    sql: CAST(FORMAT_DATE('%m', current_date()) AS INT64) ;;
  }

  dimension: yr {
    type: number
    label: "Current Year"
    group_label: "Date Utilities"
    description: "Current year"
    sql: CAST(FORMAT_DATE('%Y', current_date()) AS INT64) ;;
  }

  dimension: mt_day {
    type: number
    label: "Transaction Day"
    group_label: "Date Utilities"
    description: "Transaction's day of month"
    sql: CAST(FORMAT_DATE('%e', ${mt_posting_date}) AS INT64) ;;
  }

  dimension: mt_mon {
    type: number
    label: "Transaction Month"
    group_label: "Date Utilities"
    description: "Transaction's month"
    sql: CAST(FORMAT_DATE('%m', ${mt_posting_date}) AS INT64) ;;
  }

  dimension: mt_yr {
    type: number
    label: "Transaction Year"
    group_label: "Date Utilities"
    description: "Transaction's year"
    sql: CAST(FORMAT_DATE('%Y', ${mt_posting_date}) AS INT64) ;;
  }

  # ======================== ORIGINAL MEASURES ================================

  measure: total_spend {
    type: sum
    group_label: "Core Spend Metrics"
    label: "Gross Spends in Cr"
    description: "Gross spends in crore"
    sql: ${spend_amount}/10000000 ;;
    value_format: "#,##0.00"
  }

  measure: total_reversal {
    type: sum
    group_label: "Core Spend Metrics"
    sql: ${reversal_amount}/10000000;;
    label: "Reversals in Cr"
    description: "Reversals in crore"
    value_format: "#,##0.00"
  }

  measure: total_net_transaction {
    type: sum
    group_label: "Core Spend Metrics"
    label: "Net Spends in Cr"
    description: "Net spends in crore"
    sql: ${net_transaction}/10000000 ;;
    value_format: "#,##0.00"
  }

  measure: average_spend {
    type: average
    group_label: "Core Spend Metrics"
    sql: ${spend_amount};;
    label: "Average Gross Spend per Transaction"
    value_format: "#,##0.00"
  }

  measure: average_net_transaction {
    type: average
    group_label: "Core Spend Metrics"
    label: "Average Net Spend per Transaction"
    sql: ${net_transaction};;
    value_format: "#,##0.00"
  }

  measure: transaction_count {
    label: "Count of Transactions"
    group_label: "Core Spend Metrics"
    type: count
  }

  measure: unique_accts_cnt {
    type: count_distinct
    group_label: "Core Spend Metrics"
    label: "Unique Account Count"
    sql: ${acct} ;;
  }

  # ======================== MTD MEASURES =====================================

  measure: total_net_transactions_mtd {
    type: sum
    group_label: "MTD Metrics"
    label: "MTD Net Spends in Cr"
    description: "Month to date net spends in crore"
    sql: CASE WHEN ${mt_day} <= ${day}-1 THEN ${net_transaction}/10000000 ELSE NULL END ;;
    value_format: "#,##0.00"
  }

  measure: total_spends_mtd {
    type: sum
    group_label: "MTD Metrics"
    label: "MTD Gross Spends in Cr"
    description: "Month to date gross spends in crore"
    sql: CASE WHEN ${mt_day} <= ${day}-1 THEN ${spend_amount}/10000000 ELSE NULL END ;;
    value_format: "#,##0.00"
  }

  measure: total_reversal_mtd {
    type: sum
    group_label: "MTD Metrics"
    label: "MTD Reversals in Cr"
    description: "Month to date reversals in crore"
    sql: CASE WHEN ${mt_day} <= ${day}-1 THEN ${reversal_amount}/10000000 ELSE NULL END ;;
    value_format: "#,##0.00"
  }

  measure: avg_net_transactions_mtd {
    type: average
    group_label: "MTD Metrics"
    label: "MTD Avg Net Spend per Transaction"
    description: "Month to date average net spend per transaction"
    sql: CASE WHEN ${mt_day} <= ${day}-1 THEN ${net_transaction} ELSE NULL END ;;
    value_format: "#,##0.00"
  }

  # =================== BUSINESS BREAKDOWN/NEW MEASURES =======================

  measure: total_gross_spend {
    type: sum
    group_label: "Business Breakdown"
    label: "Total Gross Spend"
    sql: ${spend_amount} ;;
    value_format_name: "decimal_2"
    description: "Sum of spend amount"
  }

  measure: total_net_spend {
    type: sum
    group_label: "Business Breakdown"
    label: "Total Net Spend"
    sql: ${net_transaction} ;;
    value_format_name: "decimal_2"
    description: "Sum of net transaction"
  }

  measure: total_reversal_amount {
    type: sum
    group_label: "Business Breakdown"
    label: "Total Reversal Amount"
    sql: ${reversal_amount} ;;
    value_format_name: "decimal_2"
  }

  measure: spend_by_brand {
    type: sum
    group_label: "Business Breakdown"
    label: "Spend by Brand"
    sql: CASE WHEN ${brand} IS NOT NULL THEN ${spend_amount} ELSE 0 END ;;
    value_format_name: "decimal_2"
    description: "Total spend for each brand"
  }

  measure: txn_count_by_brand {
    type: count
    group_label: "Business Breakdown"
    label: "Txn Count by Brand"
    filters: [brand: "-null"]
    sql: ${mt_ref_nbr} ;;
  }

  measure: spend_by_txn_type {
    type: sum
    group_label: "Business Breakdown"
    label: "Spend by Transaction Type"
    sql: CASE WHEN ${transaction_type} IS NOT NULL THEN ${spend_amount} ELSE 0 END ;;
    value_format_name: "decimal_2"
    description: "Total spend by transaction type"
  }

  measure: spend_domestic {
    type: sum
    group_label: "Business Breakdown"
    label: "Domestic Spend"
    sql: CASE WHEN UPPER(${spend_place}) = 'DOM' THEN ${spend_amount} ELSE 0 END ;;
    value_format_name: "decimal_2"
    description: "Domestic spends only"
  }

  measure: spend_international {
    type: sum
    group_label: "Business Breakdown"
    label: "International Spend"
    sql: CASE WHEN UPPER(${spend_place}) = 'FR' THEN ${spend_amount} ELSE 0 END ;;
    value_format_name: "decimal_2"
    description: "International spends only"
  }

  measure: avg_spend_per_account {
    type: number
    group_label: "Business Breakdown"
    label: "Avg Spend per Account"
    sql: CASE WHEN ${unique_accts_cnt} > 0 THEN ${total_gross_spend} / ${unique_accts_cnt} ELSE NULL END ;;
    value_format_name: "decimal_2"
  }

  measure: total_transactions {
    type: count_distinct
    group_label: "Business Breakdown"
    label: "Unique Transactions"
    sql: ${mt_ref_nbr} ;;
    description: "Number of unique transactions"
  }

  # (Optional - Only if you have a Customer_ID field)
  # measure: unique_customers_cnt {
  #   type: count_distinct
  #   group_label: "Business Breakdown"
  #   label: "Unique Customer Count"
  #   sql: ${TABLE}.Customer_ID ;;
  #   description: "Number of unique customers"
  # }
}












view: spend_view_new {
  sql_table_name: `your_project.your_dataset.SPEND_VIEW_*` ;;

  # ------------------- DIMENSIONS -------------------

  dimension: mt_posting_date {
    type: date
    label: "Posting Date"
    sql: ${TABLE}.MT_POSTING_DATE ;;
  }

  dimension: mcc_code {
    type: string
    label: "MCC Code"
    sql: CAST(${TABLE}.MCC_CODE AS STRING) ;;
  }

  dimension: merchant_details {
    type: string
    label: "Merchant Details"
    sql: ${TABLE}.Merchant_Details ;;
  }

  dimension: description {
    type: string
    label: "Description"
    sql: ${TABLE}.Description ;;
  }

  dimension: org {
    type: number
    label: "ORG"
    sql: ${TABLE}.ORG ;;
  }

  dimension: transaction_type {
    type: string
    label: "Transaction Type"
    sql: ${TABLE}.TRANSACTION_TYPE ;;
    description: "Type of transaction: POS, Ecommerce, Cash, etc."
  }

  dimension: spend_type {
    type: string
    label: "Spend Type"
    sql: ${TABLE}.SPEND_TYPE ;;
    description: "Debit/Credit, EMI, etc."
  }

  dimension: segment_name {
    type: string
    label: "Segment Name"
    sql: ${TABLE}.Segment_Name ;;
  }

  dimension: acct {
    type: string
    label: "Account Number"
    sql: ${TABLE}.acct ;;
  }

  dimension: mt_type {
    type: string
    label: "MT Type"
    sql: ${TABLE}.mt_type ;;
    description: "Card type (if available)"
  }

  dimension: spend_place {
    type: string
    label: "Spend Place"
    sql: ${TABLE}.Spend_Place ;;
    description: "DOM = Domestic, FR = International"
  }

  dimension: product {
    type: string
    label: "Product"
    sql: ${TABLE}.Product ;;
    description: "Card/Account product"
  }

  dimension: spend_amount {
    type: number
    label: "Spend Amount"
    sql: ${TABLE}.Spend_Amount ;;
  }

  dimension: reversal_amount {
    type: number
    label: "Reversal Amount"
    sql: ${TABLE}.Reversal_Amount ;;
  }

  dimension: net_transaction {
    type: number
    label: "Net Transaction"
    sql: ${TABLE}.Net_Transaction ;;
  }

  dimension: spend_amount_cmb {
    type: number
    label: "Spend Amount CMB"
    sql: ${TABLE}.SPEND_AMOUNT_CMB ;;
  }

  dimension: spend_amount_rbmw {
    type: number
    label: "Spend Amount RBMW"
    sql: ${TABLE}.SPEND_AMOUNT_RBMW ;;
  }

  dimension: mt_ref_nbr {
    type: string
    label: "MT Reference Number"
    sql: ${TABLE}.MT_REF_NBR ;;
    description: "Unique transaction reference"
    primary_key: yes
  }

  dimension: brand {
    type: string
    label: "Brand"
    sql: ${TABLE}.BRAND ;;
  }

  dimension: final_category {
    type: string
    label: "Final Category"
    sql: ${TABLE}.FINAL_CATEGORY ;;
  }

  dimension: category_general_desc {
    type: string
    label: "Category General Description"
    sql: ${TABLE}.CATEGORY_GENERAL_DESC ;;
  }

  dimension: category_desc {
    type: string
    label: "Category Description"
    sql: ${TABLE}.CATEGORY_DESC ;;
  }

  # ------------------- MEASURES -------------------

  # Total spend amount (Gross)
  measure: total_gross_spend {
    type: sum
    label: "Total Gross Spend"
    sql: ${spend_amount} ;;
    value_format_name: "decimal_2"
    description: "Sum of spend amount"
  }

  # Total net spend (after reversal)
  measure: total_net_spend {
    type: sum
    label: "Total Net Spend"
    sql: ${net_transaction} ;;
    value_format_name: "decimal_2"
    description: "Sum of net transaction"
  }

  measure: total_reversal_amount {
    type: sum
    label: "Total Reversal Amount"
    sql: ${reversal_amount} ;;
    value_format_name: "decimal_2"
  }

  measure: unique_accts_cnt {
    type: count_distinct
    label: "Unique Accounts Count"
    sql: ${acct} ;;
    description: "Number of unique accounts"
  }

  measure: unique_customers_cnt {
    type: count_distinct
    label: "Unique Customer Count"
    sql: ${TABLE}.Customer_ID ;; # Replace with correct field if you have Customer_ID, otherwise remove
    description: "Number of unique customers"
  }

  # Spend by brand (filtered measure: example for dashboarding)
  measure: spend_by_brand {
    type: sum
    label: "Spend by Brand"
    sql: CASE WHEN ${brand} IS NOT NULL THEN ${spend_amount} ELSE 0 END ;;
    value_format_name: "decimal_2"
    description: "Total spend for each brand"
  }

  # Count of transactions by brand
  measure: txn_count_by_brand {
    type: count
    label: "Txn Count by Brand"
    filters: [brand: "-null"]
    sql: ${mt_ref_nbr} ;;
  }

  # Spend by transaction type (POS, ECOM, CASH, etc.)
  measure: spend_by_txn_type {
    type: sum
    label: "Spend by Transaction Type"
    sql: CASE WHEN ${transaction_type} IS NOT NULL THEN ${spend_amount} ELSE 0 END ;;
    value_format_name: "decimal_2"
    description: "Total spend by transaction type"
  }

  # Spend by geography (Domestic/International)
  measure: spend_domestic {
    type: sum
    label: "Domestic Spend"
    sql: CASE WHEN UPPER(${spend_place}) = 'DOM' THEN ${spend_amount} ELSE 0 END ;;
    value_format_name: "decimal_2"
    description: "Domestic spends only"
  }

  measure: spend_international {
    type: sum
    label: "International Spend"
    sql: CASE WHEN UPPER(${spend_place}) = 'FR' THEN ${spend_amount} ELSE 0 END ;;
    value_format_name: "decimal_2"
    description: "International spends only"
  }

  # Average spend per account
  measure: avg_spend_per_account {
    type: number
    label: "Average Spend per Account"
    sql: CASE WHEN ${unique_accts_cnt} > 0 THEN ${total_gross_spend} / ${unique_accts_cnt} ELSE NULL END ;;
    value_format_name: "decimal_2"
  }

  # Transaction count
  measure: total_transactions {
    type: count_distinct
    label: "Unique Transactions"
    sql: ${mt_ref_nbr} ;;
    description: "Number of unique transactions"
  }
}





















view: spend_view2 {
  sql_table_name: `your_project.your_dataset.SPEND_VIEW_2` ;;

  # --- Dimensions ---

  dimension: mt_posting_date {
    type: date
    label: "Posting Date"
    sql: ${TABLE}.MT_POSTING_DATE ;;
  }

  dimension: mcc_code {
    type: number
    label: "MCC Code"
    sql: ${TABLE}.MCC_CODE ;;
  }

  dimension: merchant_details {
    type: string
    label: "Merchant Details"
    sql: ${TABLE}.Merchant_Details ;;
  }

  dimension: description {
    type: string
    label: "Description"
    sql: ${TABLE}.Description ;;
  }

  dimension: org {
    type: number
    label: "ORG"
    sql: ${TABLE}.ORG ;;
  }

  dimension: transaction_type {
    type: string
    label: "Transaction Type"
    sql: ${TABLE}.TRANSACTION_TYPE ;;
  }

  dimension: spend_type {
    type: string
    label: "Spend Type"
    sql: ${TABLE}.SPEND_TYPE ;;
  }

  dimension: segment_name {
    type: string
    label: "Segment Name"
    sql: ${TABLE}.Segment_Name ;;
  }

  dimension: acct {
    type: string
    label: "Account Number"
    sql: ${TABLE}.acct ;;
  }

  dimension: mt_type {
    type: string
    label: "MT Type"
    sql: ${TABLE}.mt_type ;;
  }

  dimension: spend_place {
    type: string
    label: "Spend Place"
    sql: ${TABLE}.Spend_Place ;;
  }

  dimension: product {
    type: string
    label: "Product"
    sql: ${TABLE}.Product ;;
  }

  dimension: mt_ref_nbr {
    type: string
    label: "MT Reference Number"
    sql: ${TABLE}.MT_REF_NBR ;;
    primary_key: yes
  }

  dimension: brand {
    type: string
    label: "Brand"
    sql: ${TABLE}.BRAND ;;
  }

  dimension: final_category {
    type: string
    label: "Final Category"
    sql: ${TABLE}.FINAL_CATEGORY ;;
  }

  dimension: category_general_desc {
    type: string
    label: "Category General Description"
    sql: ${TABLE}.CATEGORY_GENERAL_DESC ;;
  }

  dimension: category_desc {
    type: string
    label: "Category Description"
    sql: ${TABLE}.CATEGORY_DESC ;;
  }

  # --- Measures: Spend Analytics ---

  measure: total_gross_spend {
    type: sum
    sql: ${TABLE}.Spend_Amount ;;
    label: "Total Gross Spend"
    value_format_name: "decimal_2"
    description: "Sum of Spend_Amount (Gross Spend)"
  }

  measure: total_reversal_amount {
    type: sum
    sql: ${TABLE}.Reversal_Amount ;;
    label: "Total Reversal Amount"
    value_format_name: "decimal_2"
    description: "Sum of Reversal_Amount"
  }

  measure: net_spend {
    type: number
    sql: ${total_gross_spend} - ${total_reversal_amount} ;;
    label: "Net Spend"
    value_format_name: "decimal_2"
    description: "Gross Spend minus Reversal Amount"
  }

  measure: avg_gross_spend {
    type: average
    sql: ${TABLE}.Spend_Amount ;;
    label: "Average Gross Spend"
    value_format_name: "decimal_2"
    description: "Average gross spend per transaction"
  }

  measure: avg_net_spend {
    type: number
    sql: CASE WHEN COUNT(${mt_ref_nbr}) > 0 THEN (${net_spend}) / COUNT(${mt_ref_nbr}) ELSE NULL END ;;
    label: "Average Net Spend"
    value_format_name: "decimal_2"
    description: "Net Spend divided by count of transactions"
  }

  measure: count_transactions {
    type: count_distinct
    sql: ${TABLE}.MT_REF_NBR ;;
    label: "Transaction Count"
    description: "Distinct number of transactions"
  }

  measure: total_net_transaction {
    type: sum
    sql: ${TABLE}.Net_Transaction ;;
    label: "Net Transaction (DB column)"
    value_format_name: "decimal_2"
    description: "Sum of Net_Transaction column"
  }

  measure: total_spend_amount_cmb {
    type: sum
    sql: ${TABLE}.SPEND_AMOUNT_CMB ;;
    label: "Spend Amount CMB"
    value_format_name: "decimal_2"
    description: "Sum of SPEND_AMOUNT_CMB"
  }

  measure: total_spend_amount_rbmw {
    type: sum
    sql: ${TABLE}.SPEND_AMOUNT_RBMW ;;
    label: "Spend Amount RBMW"
    value_format_name: "decimal_2"
    description: "Sum of SPEND_AMOUNT_RBMW"
  }
}
